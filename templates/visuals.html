{% extends "base.html" %}
{% block title %}Visuals — House Price AI{% endblock %}
{% block content %}
<section class="visuals-section">
  <div class="card wide-card">
    <div class="card-header">
      <div>
        <p class="muted" style="margin:0;">Insights</p>
        <h2 style="margin:.2rem 0;">Market visuals</h2>
      </div>
      <div class="card-actions">
        {% if links.dashboard %}<a class="btn small ghost" href="{{ links.dashboard }}">Dashboard</a>{% endif %}
      </div>
    </div>
    <p class="muted">Spot price swings and area relationships. Hover any point for exact values.</p>
  </div>

  <div class="visuals-grid">
    <div class="chart-card">
      <h3>Average price by bedrooms</h3>
      <canvas id="bedroomsChart"></canvas>
    </div>
    <div class="chart-card">
      <h3>Living area vs price</h3>
      <canvas id="areaChart"></canvas>
    </div>
  </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const priceList = JSON.parse('{{ price_list|tojson|safe }}');
  const bedrooms = JSON.parse('{{ bedrooms|tojson|safe }}');
  const avgPriceByBed = JSON.parse('{{ avg_price_by_bed|tojson|safe }}');
  const areaPairsRaw = JSON.parse('{{ area_pairs|tojson|safe }}');
  const areaPairs = areaPairsRaw.map(pair => ({ x: pair[0], y: pair[1] }));

  const currencyFormatter = new Intl.NumberFormat('en-IN', {
    style: 'currency',
    currency: 'INR',
    maximumFractionDigits: 0
  });

  document.addEventListener('DOMContentLoaded', () => {
    const bedCtx = document.getElementById('bedroomsChart').getContext('2d');
    new Chart(bedCtx, {
      type: 'bar',
      data: {
        labels: bedrooms.map(b => `${b} Bedrooms`),
        datasets: [{
          label: 'Average price',
          data: bedrooms.map(b => avgPriceByBed[b] || 0),
          backgroundColor: 'rgba(145,111,255,0.6)',
          borderColor: 'rgba(145,111,255,1)',
          borderWidth: 1,
          borderRadius: 6
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: ctx => currencyFormatter.format(ctx.parsed.y)
            }
          }
        },
        scales: {
          y: {
            ticks: {
              callback: value => currencyFormatter.format(value)
            },
            grid: { color: 'rgba(255,255,255,0.04)' }
          },
          x: { grid: { display: false } }
        }
      }
    });

    const areaCtx = document.getElementById('areaChart').getContext('2d');
    new Chart(areaCtx, {
      type: 'scatter',
      data: {
        datasets: [{
          label: 'Area vs price',
          data: areaPairs,
          backgroundColor: 'rgba(255,111,156,0.6)',
          borderColor: 'rgba(255,111,156,1)',
          pointRadius: 5
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          tooltip: {
            callbacks: {
              label: ctx => `Area: ${ctx.parsed.x} sq ft — ${currencyFormatter.format(ctx.parsed.y)}`
            }
          }
        },
        scales: {
          x: {
            title: { display: true, text: 'Living area (sq ft)' },
            grid: { color: 'rgba(255,255,255,0.04)' }
          },
          y: {
            title: { display: true, text: 'Price (₹)' },
            ticks: {
              callback: value => currencyFormatter.format(value)
            },
            grid: { color: 'rgba(255,255,255,0.04)' }
          }
        }
      }
    });
  });
</script>
{% endblock %}